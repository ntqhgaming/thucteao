<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>T√†i X·ªâu - Phi√™n C∆∞·ª£c M·ªõi</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
--bg-color: #1a1a2e;
--container-bg: rgba(26, 26, 46, 0.7);
--mat-bg: #16213e;
--accent-gold: #e9b384;
--text-light: #e0fbfc;
--color-tai: #ff4848;
--color-xiu: #48a9ff;
--color-win: #2ecc71;
--color-loss: #e74c3c;
--border-color: rgba(233, 179, 132, 0.3);
}

/* --- C√†i ƒë·∫∑t c∆° b·∫£n & N·ªÅn --- */
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Poppins', sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: var(--bg-color); background-image: linear-gradient(315deg, #1a1a2e 0%, #16213e 74%); color: var(--text-light); padding: 20px; }

/* --- B·ªë c·ª•c ch√≠nh --- */
.app-container { display: flex; gap: 20px; width: 100%; max-width: 900px; }
.main-game { flex-grow: 1; }

/* --- Container Game --- */
.game-container { width: 100%; background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); text-align: center; }

/* --- Header (Ti·ªÅn & Timer & Phi√™n) --- */
.header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; }
#money-display { font-size: 1.5em; font-weight: 700; color: #fff; background: rgba(0,0,0,0.2); padding: 5px 15px; border-radius: 10px; }
#session-display { font-size: 1.2em; font-weight: 600; color: var(--accent-gold); }
#timer-display { width: 70px; height: 70px; border-radius: 50%; background: rgba(0,0,0,0.2); border: 3px solid var(--color-win); display: flex; justify-content: center; align-items: center; font-size: 2.2em; font-weight: 700; color: #fff; transition: all 0.3s ease; }
#timer-display.locked { border-color: var(--color-loss); box-shadow: 0 0 15px var(--color-loss); animation: pulse 1s infinite; }
@keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

/* --- Chi·∫øu b·∫°c --- */
.game-mat { width: 100%; height: 220px; background-color: var(--mat-bg); border: 2px solid var(--border-color); border-radius: 15px; margin: 0 auto 20px auto; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
.dice-area { position: relative; width: 180px; height: 180px; }

/* --- B√°t & X√∫c x·∫Øc --- */
.bowl { width: 160px; height: 80px; background: radial-gradient(circle at 50% 100%, #5c5c8a, #2a2a3e); border: 1px solid var(--accent-gold); border-bottom: none; border-radius: 160px 160px 0 0; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; cursor: pointer; box-shadow: 0 -5px 20px rgba(0,0,0,0.4); transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
.bowl.revealed { transform: translate(-50%, -220%); }
.bowl.shaking { animation: shake-animation 0.5s infinite; }
@keyframes shake-animation { 0% { transform: translate(-50%, -50%) rotate(0deg); } 25% { transform: translate(-55%, -55%) rotate(-5deg); } 50% { transform: translate(-45%, -45%) rotate(5deg); } 75% { transform: translate(-52%, -52%) rotate(-3deg); } 100% { transform: translate(-48%, -48%) rotate(3deg); } }
.dice { width: 45px; height: 45px; background-color: #fff8e1; border-radius: 6px; position: absolute; box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3); display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); padding: 5px; opacity: 0; }
.dice.magic-appear { opacity: 1; animation: magic-dice-appear 0.7s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
@keyframes magic-dice-appear { from { opacity: 0; transform: var(--start-transform, scale(0) rotate(0deg)); } to { opacity: 1; transform: var(--end-transform, scale(1) rotate(360deg)); } }
.dot { width: 9px; height: 9px; background-color: #c0392b; border-radius: 50%; align-self: center; justify-self: center; }
.face-1 .dot:nth-child(1){grid-area:2/2}.face-2 .dot:nth-child(1){grid-area:1/1}.face-2 .dot:nth-child(2){grid-area:3/3}.face-3 .dot:nth-child(1){grid-area:1/1}.face-3 .dot:nth-child(2){grid-area:2/2}.face-3 .dot:nth-child(3){grid-area:3/3}.face-4 .dot:nth-child(1){grid-area:1/1}.face-4 .dot:nth-child(2){grid-area:1/3}.face-4 .dot:nth-child(3){grid-area:3/1}.face-4 .dot:nth-child(4){grid-area:3/3}.face-5 .dot:nth-child(1){grid-area:1/1}.face-5 .dot:nth-child(2){grid-area:1/3}.face-5 .dot:nth-child(3){grid-area:2/2}.face-5 .dot:nth-child(4){grid-area:3/1}.face-5 .dot:nth-child(5){grid-area:3/3}.face-6 .dot:nth-child(1){grid-area:1/1}.face-6 .dot:nth-child(2){grid-area:1/3}.face-6 .dot:nth-child(3){grid-area:2/1}.face-6 .dot:nth-child(4){grid-area:2/3}.face-6 .dot:nth-child(5){grid-area:3/1}.face-6 .dot:nth-child(6){grid-area:3/3}

/* --- C·∫ßu (Roadmap) --- */
.roadmap-container { width: 100%; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 10px; margin-bottom: 20px; overflow: hidden; }
.roadmap-track { display: flex; justify-content: flex-start; gap: 8px; transition: opacity 0.3s ease; }
.roadmap-track.clearing { opacity: 0; }
.roadmap-item { width: 35px; height: 35px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: 700; font-size: 1.2em; color: #fff; flex-shrink: 0; animation: pop-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
@keyframes pop-in { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
.roadmap-item.tai { background-color: var(--color-tai); } .roadmap-item.xiu { background-color: var(--color-xiu); }

/* --- V√πng ƒëi·ªÅu khi·ªÉn --- */
.betting-controls { display: flex; justify-content: space-between; align-items: center; gap: 15px; margin-bottom: 20px; }
.bet-option { flex-grow: 1; padding: 15px 20px; font-size: 1.5em; font-weight: bold; border: 2px solid transparent; border-radius: 10px; cursor: pointer; transition: all 0.3s ease; color: #fff; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
.bet-option:disabled { cursor: not-allowed; filter: grayscale(80%); opacity: 0.7; }
#bet-xiu { background: linear-gradient(145deg, #4da8ff, var(--color-xiu)); }
#bet-tai { background: linear-gradient(145deg, #ff6b6b, var(--color-tai)); }
.bet-option:hover:not(:disabled) { transform: translateY(-3px); }
.bet-option.active-bet { border-color: var(--accent-gold); transform: scale(1.05); box-shadow: 0 0 20px var(--accent-gold); }
#bet-amount { width: 150px; padding: 14px; font-size: 1.5em; text-align: center; border: 2px solid var(--border-color); background-color: rgba(0,0,0,0.3); color: #fff; border-radius: 10px; font-weight: bold; transition: all 0.2s; }
#bet-amount:focus { outline: none; border-color: var(--accent-gold); box-shadow: 0 0 10px var(--accent-gold); }
#bet-amount:disabled { background: #555; cursor: not-allowed; }
#bet-amount.input-error { animation: input-shake 0.4s; border-color: var(--color-loss); }
@keyframes input-shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

/* --- K·∫øt qu·∫£ --- */
#result-message { height: 40px; font-size: 1.2em; font-weight: bold; color: var(--text-light); display: flex; justify-content: center; align-items: center; transition: all 0.3s; }

/* --- B·∫£ng L·ªãch S·ª≠ --- */
.history-panel { width: 300px; flex-shrink: 0; background: var(--container-bg); border: 1px solid var(--border-color); border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); backdrop-filter: blur(10px); display: flex; flex-direction: column; max-height: 700px; }
.history-panel h2 { text-align: center; color: var(--accent-gold); margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
#history-list { list-style: none; overflow-y: auto; flex-grow: 1; padding-right: 10px; }
#history-list::-webkit-scrollbar { width: 5px; } #history-list::-webkit-scrollbar-track { background: transparent; } #history-list::-webkit-scrollbar-thumb { background: var(--accent-gold); border-radius: 5px; }
.history-item { display: grid; grid-template-columns: 60px 30px 1fr 60px; align-items: center; gap: 5px; padding: 8px; border-radius: 5px; margin-bottom: 8px; background: rgba(0,0,0,0.2); font-size: 0.9em; }
.history-item .result { font-weight: bold; padding: 3px 8px; border-radius: 5px; color: #fff; text-align: center;}
.history-item .result.tai { background-color: var(--color-tai); } .history-item .result.xiu { background-color: var(--color-xiu); }
.history-item .dice-details { font-size: 0.8em; opacity: 0.7; }
.history-item .total { font-weight: bold; }
.history-item .winnings { font-weight: bold; text-align: right; }
.history-item .winnings.win { color: var(--color-win); }
.history-item .winnings.loss { color: var(--color-loss); }
#reset-button { margin-top: 15px; padding: 10px; background-color: #c0392b; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
#reset-button:hover { background-color: #e74c3c; }

@media (max-width: 768px) { body { align-items: flex-start; } .app-container { flex-direction: column; } .history-panel { width: 100%; max-height: 250px; } }
</style>
</head>
<body>
<div class="app-container">
<div class="main-game">
<div class="game-container">
<div class="header">
<div id="money-display">üí∞ 1000000</div>
<div id="session-display">Phi√™n 1</div>
<div id="timer-display">--</div>
</div>
<div class="game-mat">
<div class="dice-area">
<div id="bowl" class="bowl"></div>
<div id="dice1" class="dice"></div>
<div id="dice2" class="dice"></div>
<div id="dice3" class="dice"></div>
</div>
</div>
<div class="roadmap-container">
<div id="roadmap-track" class="roadmap-track"></div>
</div>
<div class="betting-controls">
<button id="bet-xiu" class="bet-option">X·ªàU</button>
<input type="text" id="bet-amount" placeholder="C∆∞·ª£c" inputmode="numeric">
<button id="bet-tai" class="bet-option">T√ÄI</button>
</div>
<div id="result-message">Chu·∫©n b·ªã v√°n m·ªõi...</div>
</div>
</div>
<div class="history-panel">
<h2>L·ªäCH S·ª¨ C∆Ø·ª¢C</h2>
<ul id="history-list"></ul>
<button id="reset-button">RESET D·ªÆ LI·ªÜU</button>
</div>
</div>
<script>
// --- DOM Elements ---
const moneyDisplay = document.getElementById('money-display');
const sessionDisplay = document.getElementById('session-display');
const timerDisplay = document.getElementById('timer-display');
const betXiuButton = document.getElementById('bet-xiu');
const betTaiButton = document.getElementById('bet-tai');
const betAmountInput = document.getElementById('bet-amount');
const resultMessage = document.getElementById('result-message');
const bowl = document.getElementById('bowl');
const allDice = [document.getElementById('dice1'), document.getElementById('dice2'), document.getElementById('dice3')];
const historyList = document.getElementById('history-list');
const roadmapTrack = document.getElementById('roadmap-track');
const resetButton = document.getElementById('reset-button');

// --- Storage Keys & State ---
const STORAGE_KEYS = { MONEY: 'taixiu_money_v9', HISTORY: 'taixiu_history_v9', SESSION_COUNT: 'taixiu_session_v9' };
let money, history, sessionRoundCount, currentBet = null, isShaking = false, countdown, timerInterval;

// --- Constants ---
const ROUND_DURATION = 15, LOCK_BET_TIME = 3, NEW_ROUND_DELAY = 5000;
const SESSION_LENGTH = 5;

// --- Game Initialization ---
function initializeGame() {
loadGameData();
updateAllUI();
setupEventListeners();
startNewRound();
}

function setupEventListeners() {
betXiuButton.addEventListener('click', () => selectBet('xiu'));
betTaiButton.addEventListener('click', () => selectBet('tai'));
resetButton.addEventListener('click', resetGameData);
bowl.addEventListener('click', () => !isShaking && bowl.classList.contains('revealed') && startNewRound());
betAmountInput.addEventListener('input', handleBetInputFormatting);
}

// --- Game Loop ---
function startNewRound() {
clearTimeout(timerInterval); isShaking = false; countdown = ROUND_DURATION; resetRoundUI();

// THAY ƒê·ªîI ·ªû ƒê√ÇY: Logic ki·ªÉm tra v√† reset phi√™n
if (sessionRoundCount >= SESSION_LENGTH) {
sessionRoundCount = 0; // Reset b·ªô ƒë·∫øm
// Hi·ªáu ·ª©ng x√≥a c·∫ßu
roadmapTrack.classList.add('clearing');
setTimeout(() => {
roadmapTrack.innerHTML = '';
roadmapTrack.classList.remove('clearing');
}, 300);
}

tick();
timerInterval = setInterval(tick, 1000);
}

function tick() {
updateTimerDisplay();
if (countdown <= LOCK_BET_TIME && countdown > 0) lockBetting();
if (countdown <= 0) { clearInterval(timerInterval); runShakeSequence(); }
countdown--;
}

function runShakeSequence() {
const betAmount = parseFormattedNumber(betAmountInput.value);
if (isShaking) return;
if (money < betAmount) { showError("Kh√¥ng ƒë·ªß ti·ªÅn c∆∞·ª£c!"); setTimeout(startNewRound, NEW_ROUND_DELAY); return; }
isShaking = true;
resetRoundVisuals();
setTimeout(() => {
let shakeCount = 0;
const shakeInterval = setInterval(() => {
bowl.classList.add('shaking'); setTimeout(() => bowl.classList.remove('shaking'), 400);
shakeCount++;
if (shakeCount >= 3) { clearInterval(shakeInterval); setTimeout(() => revealResult(betAmount), 500); }
}, 600);
}, 500);
}

function revealResult(betAmount) {
const [d1, d2, d3] = [1, 2, 3].map(() => Math.floor(Math.random() * 6) + 1);
const total = d1 + d2 + d3;
positionAndShowDice(d1, d2, d3); bowl.classList.add('revealed');

// THAY ƒê·ªîI ·ªû ƒê√ÇY: Lo·∫°i b·ªè ho√†n to√†n logic "B√£o"
let gameResultType = (total <= 10) ? 'xiu' : 'tai';
let winnings = 0;
let finalMessage = `${d1}-${d2}-${d3} = ${total}ƒë ‚á® ${gameResultType.toUpperCase()}`;

if (betAmount > 0 && currentBet) {
if (gameResultType !== currentBet) { // Ch·ªâ c√≥ 1 ƒëi·ªÅu ki·ªán thua
winnings = -betAmount;
money -= betAmount;
finalMessage += " - B·∫°n thua!";
} else { // Th·∫Øng
winnings = betAmount;
money += betAmount;
finalMessage += " - B·∫°n th·∫Øng!";
}
}

sessionRoundCount++; // TƒÉng b·ªô ƒë·∫øm phi√™n sau khi c√≥ k·∫øt qu·∫£
updateHistory(gameResultType, total, [d1, d2, d3], betAmount, winnings);
saveGameData();
updateAllUI();
resultMessage.textContent = `V√°n m·ªõi sau ${NEW_ROUND_DELAY / 1000}s...`;
setTimeout(startNewRound, NEW_ROUND_DELAY);
}

// --- UI and Control Functions ---
function selectBet(betType) {
if (isShaking || countdown <= LOCK_BET_TIME) return;
currentBet = betType;
betTaiButton.classList.toggle('active-bet', betType === 'tai');
betXiuButton.classList.toggle('active-bet', betType === 'xiu');
}

function lockBetting() {
betAmountInput.disabled = true; betTaiButton.disabled = true; betXiuButton.disabled = true;
if (countdown === LOCK_BET_TIME) resultMessage.textContent = "H·∫øt gi·ªù c∆∞·ª£c!";
}

function resetRoundUI() {
bowl.classList.remove('revealed'); allDice.forEach(d => { d.className = 'dice'; });
betTaiButton.classList.remove('active-bet'); betXiuButton.classList.remove('active-bet');
betAmountInput.value = ''; currentBet = null;
betAmountInput.disabled = false; betTaiButton.disabled = false; betXiuButton.disabled = false;
resultMessage.textContent = 'ƒê·∫∑t c∆∞·ª£c ƒëi...';
updateSessionDisplay();
}

function resetRoundVisuals() {
bowl.classList.remove('revealed'); allDice.forEach(d => { d.className = 'dice'; });
resultMessage.textContent = 'ƒêang l·∫Øc...';
}

function updateTimerDisplay() {
timerDisplay.textContent = countdown >= 0 ? countdown : 0;
timerDisplay.classList.toggle('locked', countdown <= LOCK_BET_TIME);
}

// --- Dice Animation ---
function positionAndShowDice(v1, v2, v3) {
const values = [v1, v2, v3];
const endPositions = [{ top: '35%', left: '10%' }, { top: '35%', left: '40%' }, { top: '35%', left: '70%' }];
const startTransforms = ['translate(-200px, -150px) scale(0) rotate(-270deg)', 'translate(0px, 200px) scale(0) rotate(180deg)', 'translate(200px, -150px) scale(0) rotate(270deg)'];
allDice.forEach((dice, i) => {
dice.className = 'dice'; updateDiceUI(dice, values[i]);
const endPos = endPositions[i]; dice.style.top = endPos.top; dice.style.left = endPos.left;
dice.style.setProperty('--start-transform', startTransforms[i]);
dice.style.setProperty('--end-transform', `translate(-50%, -50%) scale(1) rotate(${Math.random() * 360}deg)`);
dice.classList.add('magic-appear'); dice.style.animationDelay = `${i * 0.1}s`;
});
}
function updateDiceUI(diceEl, value) { diceEl.classList.add(`face-${value}`); diceEl.innerHTML = Array(value).fill('<div class="dot"></div>').join(''); }

// --- Input Formatting ---
function handleBetInputFormatting(e) {
const input = e.target; const cursorPosition = input.selectionStart;
let rawValue = input.value.replace(/[^0-9]/g, '');
if (parseInt(rawValue, 10) > money) { rawValue = String(money); }
const formattedValue = rawValue.length > 0 ? parseInt(rawValue, 10).toLocaleString('en-US') : '';
const lengthDiff = formattedValue.length - input.value.length;
input.value = formattedValue;
const newCursorPosition = cursorPosition + lengthDiff;
if (newCursorPosition >= 0 && newCursorPosition <= formattedValue.length) { input.setSelectionRange(newCursorPosition, newCursorPosition); }
}
function parseFormattedNumber(formattedString) { return parseInt(formattedString.replace(/,/g, ''), 10) || 0; }

// --- Data Management & History/Roadmap UI ---
function loadGameData() {
money = parseInt(localStorage.getItem(STORAGE_KEYS.MONEY), 10) || 1000000;
history = JSON.parse(localStorage.getItem(STORAGE_KEYS.HISTORY)) || [];
sessionRoundCount = parseInt(localStorage.getItem(STORAGE_KEYS.SESSION_COUNT), 10) || 0;
}
function saveGameData() {
localStorage.setItem(STORAGE_KEYS.MONEY, money);
localStorage.setItem(STORAGE_KEYS.HISTORY, JSON.stringify(history));
localStorage.setItem(STORAGE_KEYS.SESSION_COUNT, sessionRoundCount);
}
function resetGameData() { if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô ti·ªÅn v√† l·ªãch s·ª≠?')) { localStorage.clear(); location.reload(); } }

function updateHistory(result, total, diceValues, betAmount, winnings) {
history.unshift({ result, total, diceValues, betAmount, winnings, id: Date.now() });
if (history.length > 50) history.pop();
}

function updateAllUI() {
updateMoneyDisplay();
updateHistoryUI();
updateRoadmapUI();
updateSessionDisplay();
}

function updateSessionDisplay() {
sessionDisplay.textContent = `Phi√™n ${sessionRoundCount + 1 > SESSION_LENGTH ? 1 : sessionRoundCount + 1}`;
}

function updateHistoryUI() {
historyList.innerHTML = history.length === 0 ? '<li style="text-align:center; opacity: 0.5;">Ch∆∞a c√≥ l·ªãch s·ª≠</li>'
: history.map(entry => {
const resultText = entry.result.charAt(0).toUpperCase() + entry.result.slice(1);
let winningsHtml = entry.betAmount > 0 ? `<span class="winnings ${entry.winnings >= 0 ? 'win' : 'loss'}">${entry.winnings >= 0 ? '+' : ''}${entry.winnings.toLocaleString()}</span>` : `<span class="winnings">--</span>`;
return `<li class="history-item"><span class="result ${entry.result}">${resultText}</span><span class="total">${entry.total}</span><span class="dice-details">${entry.diceValues.join('-')}</span>${winningsHtml}</li>`;
}).join('');
}

function updateRoadmapUI() {
const lastResult = history[0];
if (!lastResult) return; // Kh√¥ng l√†m g√¨ n·∫øu ch∆∞a c√≥ l·ªãch s·ª≠

// Th√™m m·ª•c m·ªõi v√†o c·∫ßu
const letter = lastResult.result === 'tai' ? 'T' : 'X';
const roadmapItem = document.createElement('div');
roadmapItem.className = `roadmap-item ${lastResult.result}`;
roadmapItem.textContent = letter;
roadmapTrack.appendChild(roadmapItem);
}

function updateMoneyDisplay() { moneyDisplay.textContent = `üí∞ ${money.toLocaleString()}`; }
function showError(message) {
resultMessage.textContent = message; resultMessage.style.color = 'var(--color-loss)';
betAmountInput.classList.add('input-error');
setTimeout(() => { resultMessage.style.color = 'var(--text-light)'; betAmountInput.classList.remove('input-error'); }, 1500);
}

// --- Start Game ---
initializeGame();
</script>
</body>
</html>